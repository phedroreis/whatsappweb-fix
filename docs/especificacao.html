<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/frames.css"/>
    <link rel="stylesheet" href="css/javacode.css"/>
    <title>Especificação</title>
</head>
<body>
    <section class="frame-sections">
      <h1>Especificação</h1>

      <p>
        As classes do projeto serão distribuídas em 5 pacotes:
      </p>
      <dl class="deflist-default">
        <dt>whatsappwebfix</dt>
        <dd>
          Contém as classes WhatsAppEditor, NormalizeFilenames e DownloadPngs que fazem o trabalho principal em seus respectivos executáveis.
        <dt>whatsappwebfix.util</dt>
        <dd>
          Classes utilitárias com função de preparação
        </dd> 
        <dt>whatsappwebfix.apps</dt>
        <dd>
          Classes executáveis do projeto
        </dd>
        <dt>whatsappwebfix.global</dt>
        <dd>
          Classes para constantes e definições gerais que possam ser acessadas por qualquer outra classe do projeto
        </dd> 
        <dt>whatsappwebfix.gui</dt>
        <dd>
          Classes para as interfaces gráficas dos programas
        </dd>
      </dl>

      <h2>Pacote whatsappwebfix</h2>

      <h4>Classe WhatsAppEditor</h4>

      <p>
        Esta classe deve ser a encarregada de ler o arquivo de uma página WhatsApp salva e produzir uma cópia desse arquivo onde os emojis inseridos pelo usuário apareçam renderizados.
      </p>


<div class="javacode" style="width:657px;">

        <div class="linenumber">
        000</br>001</br>002</br>003</br>004</br>005</br>006</br>007</br>008</br>009</br>010</br>011</br>012</br>013</br>014</br>015</br>016</br>017</br>018</br>019</br>020</br>021</br>022</br>023</br>024</br>025</br>026</br>027</br>028</br>029</br>030</br>031</br>032</br>033</br>034</br>035</br>036</br>037</br>038</br>039</br>040</br>041</br>042</br>043</br>044</br>045</br>046</br>047</br>048</br>049</br>050</br>051</br>052</br>053</br>054</br>055</br>056</br>057</br>058</br>059</br>060</br>061</br>062</br>063</br>064</br>065</br>066</br>067</br>068</br>069</br>070</br>071</br>072</br>073</br>074</br>075</br>076</br>077</br>078</br>079</br>080</br>081</br>082</br>083</br>084</br>085</br>086</br>087</br>088</br>089</br>090</br>091</br>092</br>093</br>094</br>095</br>096</br>097</br>098</br>099</br>100</br>101</br>102</br>103</br>104</br>105</br>106</br>107</br>108</br>109</br>110</br>111</br>112</br>113</br>114</br>115</br>116</br>117</br>118</br>119</br>120</br>121</br>122</br>123</br>124</br>125</br>126</br>127</br>128</br>129</br>130</br>131</br>132</br>133</br>134</br>135</br>136</br>137</br>138</br>139</br>140</br>141</br>142</br>143</br>144</br>145</br>146</br>147</br>148</br>149</br>150</br>151</br>152</br>153</br>154</br>155</br>156</br>157</br>158</br>159</br>160</br>161</br>162</br>163</br>164</br>165</br>166</br>167</br>168</br>169</br>170</br>171</br>172</br>173</br>174</br>175</br>176</br>177</br>178</br>179</br>180</br>181</br>182</br>183</br>184</br>185</br>186</br>187</br>188</br>189</br>190</br>191</br>192</br>193</br>194</br>195</br>196</br>197</br>198</br>199</br>200</br>201</br>202</br>203</br>204</br>205</br>206</br>207</br>208</br>209</br>210</br>211</br>212</br>213</br>214</br>215</br>216</br>217</br>218</br>219</br>220</br>221</br>222</br>223</br>224</br>225</br>226</br>227</br>228</br>229</br>230</br>231</br>232</br>233</br>234</br>235</br>236</br>237</br>238</br>239</br>240</br>241</br>242</br>243</br>244</br>245</br>246</br>247</br>248</br>249</br>250</br>251</br>252</br>253</br>254</br>255</br>256</br>257</br>258</br>259</br>260</br>261</br>262</br>263</br>264</br>265</br>266</br>267</br>268</br>269</br>270</br>271</br>272</br>273</br>274</br>275</br>276</br>277</br>
        </div>
        <pre><code>
        <span class="xw52fz_reserved">package</span> br.com.hkp.whatsappwebfix;
        
        <span class="xw52fz_reserved">import</span> <span class="xw52fz_reserved">static</span> br.com.hkp.whatsappwebfix.global.<span class="xw52fz_classname">Global</span>.<span class="xw52fz_constant">EMOJIS_DIRNAME</span>;
        <span class="xw52fz_reserved">import</span> <span class="xw52fz_reserved">static</span> br.com.hkp.whatsappwebfix.global.<span class="xw52fz_classname">Global</span>.<span class="xw52fz_constant">FILENAME_DIFF</span>;
        <span class="xw52fz_reserved">import</span> <span class="xw52fz_reserved">static</span> br.com.hkp.whatsappwebfix.global.<span class="xw52fz_classname">Global</span>.<span class="xw52fz_constant">PASTA_BASE</span>;
        <span class="xw52fz_reserved">import</span> br.com.hkp.whatsappwebfix.util.<span class="xw52fz_classname">FileTools</span>;
        <span class="xw52fz_reserved">import</span> br.com.hkp.whatsappwebfix.util.<span class="xw52fz_classname">Normalizer</span>;
        <span class="xw52fz_reserved">import</span> java.io.<span class="xw52fz_classname">BufferedWriter</span>;
        <span class="xw52fz_reserved">import</span> java.io.<span class="xw52fz_classname">File</span>;
        <span class="xw52fz_reserved">import</span> java.io.<span class="xw52fz_classname">FileWriter</span>;
        <span class="xw52fz_reserved">import</span> java.io.<span class="xw52fz_classname">IOException</span>;
        <span class="xw52fz_reserved">import</span> java.nio.charset.<span class="xw52fz_classname">StandardCharsets</span>;
        <span class="xw52fz_reserved">import</span> java.util.<span class="xw52fz_classname">HashMap</span>;
        <span class="xw52fz_reserved">import</span> java.util.regex.<span class="xw52fz_classname">Matcher</span>;
        <span class="xw52fz_reserved">import</span> java.util.regex.<span class="xw52fz_classname">Pattern</span>;
        
        
        
        <span class="xw52fz_comment">/******************************************************************************
        * Esta classe tem todos os metodos para criar uma copia editada de uma pagina
        * salva com conversas no app WhatsApp Web.
        * &lt;p&gt;
        * Esta copia deve ser capaz de exibir os emojis inseridos pelo usuario. Ao 
        * contrario do que ocorrem com as paginas originalmente salvas.
        * 
        * @author "Pedro Reis"
        * @since 29 de novembro de 2020 v1.0
        * @version v1.0
        *****************************************************************************/</span>
        <span class="xw52fz_reserved">public</span> <span class="xw52fz_reserved">final</span> <span class="xw52fz_reserved">class</span> <span class="xw52fz_classname">WhatsAppEditor</span>
        {
            <span class="xw52fz_comment">/*
            Localiza o atributo alt na tag que insere emojis
            */</span>
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_reserved">static</span> <span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">Pattern</span> <span class="xw52fz_constant">ALT_ATTR_PATTERN</span> = 
                <span class="xw52fz_classname">Pattern</span>.<span class="xw52fz_function">compile</span>(<span class="xw52fz_literalstring">"alt\\s*=\\s*\".+?\""</span>);
            
            <span class="xw52fz_comment">/*
            Localiza tags que inserem emojis
            */</span>
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_reserved">static</span> <span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">Pattern</span> <span class="xw52fz_constant">EMOJI_TAG_PATTERN</span> = 
                <span class="xw52fz_classname">Pattern</span>.<span class="xw52fz_function">compile</span>
                (
                    <span class="xw52fz_literalstring">"&lt;img src=\""</span>
                    + <span class="xw52fz_constant">PASTA_BASE</span> + <span class="xw52fz_literalstring">"\\/"</span>
                    + <span class="xw52fz_literalstring">"d5fceb6532643d0d84ffe09c40c481ecdf59e15a\\.gif.+?&gt;"</span>
                );
            
            <span class="xw52fz_comment">/*
            Aramazena todo o conteudo de um arquivo HTML
            */</span>
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_classname">String</span> htmlContent;
            
            <span class="xw52fz_comment">/*
            buffer para otimizar processos de leitura e gravacao
            */</span>
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_reserved">final</span> <span class="xw52fz_reserved">int</span> buffer;
            
            <span class="xw52fz_comment">/*
            O diretorio onde estao os arquivos HTML
            */</span>
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_reserved">static</span> <span class="xw52fz_classname">String</span> absolutePath;
          
            <span class="xw52fz_comment">/*
            Arquivo que serah lido e arquivo que sera gravado e arquivo de relatorio
            */</span>
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">File</span> inputFile;
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">File</span> outputFile;
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">File</span> reportFile;
            
            <span class="xw52fz_comment">/*
            Um HashMap para conter entradas que associam um emoji UTF-8 a sua string de
            codepoints juntamente com a informacao sobre como o emoji foi renderizado
            pelo programa. As entradas desse HashMap serao gravadas em um arquivo texto.
            */</span>
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">HashMap</span>&lt;<span class="xw52fz_classname">String</span>, <span class="xw52fz_classname">String</span>&gt; emojisReport;
            
            <span class="xw52fz_comment">/*[00]---------------------------------------------------------------------
            
            -------------------------------------------------------------------------*/</span>
            <span class="xw52fz_comment">/**
            * Construtor da classe.
            * 
            * @param file O arquivo que deve ser processado para gerar uma copia com as
            * tags que inserem emojis editadas.
            * 
            * @throws java.io.IOException Em caso de erro de IO
            */</span>
            <span class="xw52fz_reserved">public</span> <span class="xw52fz_classname">WhatsAppEditor</span>(<span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">File</span> file) <span class="xw52fz_reserved">throws</span> <span class="xw52fz_classname">IOException</span>
            {
                inputFile = file;
                    
                absolutePath = inputFile.<span class="xw52fz_function">getParent</span>() + <span class="xw52fz_literalchar">'/'</span>;
                
                <span class="xw52fz_classname">String</span> absoluteFileName = absolutePath + inputFile.<span class="xw52fz_function">getName</span>();
                    
                buffer = (<span class="xw52fz_reserved">int</span>)inputFile.<span class="xw52fz_function">length</span>();
                
                htmlContent = <span class="xw52fz_classname">FileTools</span>.<span class="xw52fz_function">readTextFile</span>(file);
                
                outputFile = 
                    <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">File</span>
                        (
                            absoluteFileName.<span class="xw52fz_function">replace</span>(<span class="xw52fz_literalstring">".html"</span>, <span class="xw52fz_constant">FILENAME_DIFF</span> + <span class="xw52fz_literalstring">".html"</span>)
                        );
                
                reportFile = <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">File</span>(absoluteFileName.<span class="xw52fz_function">replace</span>(<span class="xw52fz_literalstring">".html"</span>,<span class="xw52fz_literalstring">".report"</span>));
                
                emojisReport = <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">HashMap</span>&lt;&gt;(1000);
            }<span class="xw52fz_comment">//construtor
        </span>           
            <span class="xw52fz_comment">/*[01]---------------------------------------------------------------------
              
            -------------------------------------------------------------------------*/</span>
            <span class="xw52fz_comment">/**
            * Recebe uma string codificada em utf8 que eh o emoji a ser exibido e que
            * foi lida do valor do atributo alt. Na tag que insere emojis na pagina.
            *
            * Esta string eh utilizada para encontrar o nome do arquivo que tem a 
            * figura correspondente a este emoji.
            * 
            * @param utf8Emoji Um emoji codificado em utf8
            * 
            * @return O nome que deve ter o arquivo PNG com a imagem deste emoji
            */</span>
            <span class="xw52fz_reserved">public</span> <span class="xw52fz_classname">String</span> <span class="xw52fz_function">utf8EmojiToFilename</span>(<span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">String</span> utf8Emoji)
            {
                <span class="xw52fz_classname">String</span> codepoints = <span class="xw52fz_classname">Normalizer</span>.<span class="xw52fz_function">utf8ToCodepoints</span>(utf8Emoji);
                      
                <span class="xw52fz_classname">String</span> filename = 
                    <span class="xw52fz_constant">PASTA_BASE</span> + <span class="xw52fz_literalchar">'/'</span> + <span class="xw52fz_constant">EMOJIS_DIRNAME</span> + <span class="xw52fz_literalchar">'/'</span> + codepoints + <span class="xw52fz_literalstring">".png"</span>;
                
                <span class="xw52fz_classname">File</span> test = <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">File</span>(absolutePath + filename);
                      
                <span class="xw52fz_reserved">if</span> (!test.<span class="xw52fz_function">exists</span>())
                {
                    filename = filename.<span class="xw52fz_function">replaceAll</span>(<span class="xw52fz_literalstring">"-[-a-f0-9]+[.]png"</span>, <span class="xw52fz_literalstring">".png"</span>);
                                      
                    test = <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">File</span>(absolutePath + filename);
                    
                    <span class="xw52fz_reserved">if</span> (!test.<span class="xw52fz_function">exists</span>())
                    {
                        emojisReport.<span class="xw52fz_function">put</span>
                        (
                            utf8Emoji, 
                            codepoints + <span class="xw52fz_literalstring">" : Faltando arquivo PNG"</span>
                        );
                        <span class="xw52fz_reserved">return</span> <span class="xw52fz_reserved">null</span>;
                    }
                    <span class="xw52fz_reserved">else</span>
                    {
                        emojisReport.<span class="xw52fz_function">put</span>
                        (
                            utf8Emoji,
                            codepoints + <span class="xw52fz_literalstring">" : Renderizado com emoji raiz"</span>
                        );
                        <span class="xw52fz_reserved">return</span> (<span class="xw52fz_literalstring">"!"</span> + filename);
                    }
                }
                <span class="xw52fz_reserved">else</span>
                    emojisReport.<span class="xw52fz_function">put</span>(utf8Emoji, codepoints + <span class="xw52fz_literalstring">" : Renderizado"</span>);
                
                <span class="xw52fz_reserved">return</span> filename;
                
            }<span class="xw52fz_comment">//utf8EmojiToFilename()
        </span>    
            <span class="xw52fz_comment">/*[02]---------------------------------------------------------------------
            A partir da tag que insere emojis no arquivo original, este metodo retorna
            uma outra tag que irah inserir o emoji na copia alterada deste arquivo.
            -------------------------------------------------------------------------*/</span>
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_classname">String</span> <span class="xw52fz_function">getNewTag</span>(<span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">String</span> oldTag)
            {
                <span class="xw52fz_classname">Matcher</span> m = <span class="xw52fz_constant">ALT_ATTR_PATTERN</span>.<span class="xw52fz_function">matcher</span>(oldTag);
                
                <span class="xw52fz_reserved">if</span> (m.<span class="xw52fz_function">find</span>()) 
                {
                    <span class="xw52fz_classname">String</span> utf8Emoji = m.<span class="xw52fz_function">group</span>();
                    
                    utf8Emoji = utf8Emoji.<span class="xw52fz_function">substring</span>
                                (
                                    utf8Emoji.<span class="xw52fz_function">indexOf</span>(<span class="xw52fz_literalchar">'"'</span>) + 1, utf8Emoji.<span class="xw52fz_function">length</span>() - 1
                                ).<span class="xw52fz_function">trim</span>();
                    
                    <span class="xw52fz_classname">String</span> filename = <span class="xw52fz_function">utf8EmojiToFilename</span>(utf8Emoji);
                    
                    <span class="xw52fz_reserved">if</span> (filename == <span class="xw52fz_reserved">null</span>)
                    {
                        <span class="xw52fz_reserved">return</span> <span class="xw52fz_literalstring">"&lt;span&gt;"</span> + utf8Emoji + <span class="xw52fz_literalstring">"&lt;/span&gt;"</span>;
                    }
                    <span class="xw52fz_reserved">else</span> <span class="xw52fz_reserved">if</span> (filename.<span class="xw52fz_function">charAt</span>(0) == <span class="xw52fz_literalchar">'!'</span>)
                    {
                        <span class="xw52fz_reserved">return</span> 
                            <span class="xw52fz_literalstring">"&lt;img src=\""</span> + filename.<span class="xw52fz_function">substring</span>(1, filename.<span class="xw52fz_function">length</span>()) +
                            <span class="xw52fz_literalstring">"\" width=\"20px\" height=\"20px\""</span> +
                            <span class="xw52fz_literalstring">"style=\"border: solid 1px red;\"&gt;"</span>;
                    }
                    <span class="xw52fz_reserved">else</span>
                    {
                        <span class="xw52fz_reserved">return</span> 
                            <span class="xw52fz_literalstring">"&lt;img src=\""</span> + filename + <span class="xw52fz_literalstring">"\" alt=\""</span> + utf8Emoji +
                            <span class="xw52fz_literalstring">"\" width=\"20px\" height=\"20px\"&gt;"</span>;
                    }
              
                } 
                <span class="xw52fz_reserved">else</span>
                    <span class="xw52fz_reserved">return</span> oldTag;
          
            }<span class="xw52fz_comment">//getNewTag()
        </span>    
            <span class="xw52fz_comment">/*[03]---------------------------------------------------------------------
              Retorna um HashMap associando cada tag que foi encontrada no arquivo
              original a tag que deve substitui-la na copia editada deste arquivo.
            -------------------------------------------------------------------------*/</span>
            <span class="xw52fz_reserved">private</span> <span class="xw52fz_classname">HashMap</span>&lt;<span class="xw52fz_classname">String</span>, <span class="xw52fz_classname">String</span>&gt; <span class="xw52fz_function">getMap</span>() <span class="xw52fz_reserved">throws</span> <span class="xw52fz_classname">IOException</span>
            {
                <span class="xw52fz_classname">Matcher</span> m = <span class="xw52fz_constant">EMOJI_TAG_PATTERN</span>.<span class="xw52fz_function">matcher</span>(htmlContent);
                      
                <span class="xw52fz_classname">HashMap</span>&lt;<span class="xw52fz_classname">String</span>, <span class="xw52fz_classname">String</span>&gt; map = <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">HashMap</span>&lt;&gt;(1000);
                
                <span class="xw52fz_reserved">while</span> (m.<span class="xw52fz_function">find</span>()) map.<span class="xw52fz_function">put</span>(m.<span class="xw52fz_function">group</span>(), <span class="xw52fz_function">getNewTag</span>(m.<span class="xw52fz_function">group</span>()));
              
                <span class="xw52fz_reserved">return</span> map;
          
            }<span class="xw52fz_comment">//getMap()
        </span>      
            <span class="xw52fz_comment">/*[04]---------------------------------------------------------------------
                
            -------------------------------------------------------------------------*/</span>
            <span class="xw52fz_comment">/**
            * Grava um novo arquivo. Neste arquivo os emojis sao renderizados.
            * 
            * @throws IOException Em caso de erro de IO.
            */</span>
            <span class="xw52fz_reserved">public</span> <span class="xw52fz_reserved">void</span> <span class="xw52fz_function">createNewFile</span>() <span class="xw52fz_reserved">throws</span> <span class="xw52fz_classname">IOException</span>
            {
                <span class="xw52fz_classname">BufferedWriter</span> htmlFile = 
                    <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">BufferedWriter</span>
                    (
                        <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">FileWriter</span>(outputFile, <span class="xw52fz_classname">StandardCharsets</span>.<span class="xw52fz_constant">UTF_8</span>), buffer
                    );
                                
                <span class="xw52fz_classname">HashMap</span>&lt;<span class="xw52fz_classname">String</span>, <span class="xw52fz_classname">String</span>&gt; tagMap = <span class="xw52fz_function">getMap</span>();
                
                <span class="xw52fz_reserved">for</span>(<span class="xw52fz_classname">String</span> oldTag: tagMap.<span class="xw52fz_function">keySet</span>())
                    htmlContent = htmlContent.<span class="xw52fz_function">replace</span>(oldTag, tagMap.<span class="xw52fz_function">get</span>(oldTag));
              
                htmlFile.<span class="xw52fz_function">write</span>(htmlContent);
                
                htmlFile.<span class="xw52fz_function">close</span>();
                
                <span class="xw52fz_classname">BufferedWriter</span> report = 
                    <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">BufferedWriter</span>
                    (
                        <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">FileWriter</span>(reportFile, <span class="xw52fz_classname">StandardCharsets</span>.<span class="xw52fz_constant">UTF_8</span>), buffer
                    );
                
                <span class="xw52fz_classname">StringBuilder</span> sb = <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">StringBuilder</span>(emojisReport.<span class="xw52fz_function">size</span>() * 100);
                
                <span class="xw52fz_reserved">for</span> (<span class="xw52fz_classname">String</span> utf8Emoji: emojisReport.<span class="xw52fz_function">keySet</span>())
                {
                    sb.
                    <span class="xw52fz_function">append</span>(utf8Emoji).
                    <span class="xw52fz_function">append</span>(<span class="xw52fz_literalstring">" : "</span>).
                    <span class="xw52fz_function">append</span>(emojisReport.<span class="xw52fz_function">get</span>(utf8Emoji)).
                    <span class="xw52fz_function">append</span>(<span class="xw52fz_literalstring">"\n"</span>);
                }
                
                report.<span class="xw52fz_function">write</span>(sb.<span class="xw52fz_function">toString</span>());
                
                report.<span class="xw52fz_function">close</span>();
                
            }<span class="xw52fz_comment">//createNewFile()
        </span>    
        }<span class="xw52fz_comment">//classe WhatsAppEditor
        </span>
        </code></pre>
        </div>

      <div class="comment">
        <p>utf8EmojiToFilename()</p>
        <p>
          O método converte a String codificada em UTF-8 de um emoji no nome do arquivo que deve conter uma imagem para este emoji.
        </p>
        <p>
          Na linha 128 é chamado o método que obtém a String de codepoints em hexa e o valor é atribuído ao objeto "filename". A esta String "filename", na linha 130, é acrescentado o caminho do arquivo e a extensão .png, obtendo então o nome do arquivo que deverá conter a figura do emoji.
        </p>
        <p>
          A linha 135 testa se este arquivo de nome "filename" existe no disco.
        </p>
        <p>
          Se existir uma entrada no HashMap é inserida na linha 161. Esta entrada será impressa em um arquivo de relatório indicando que este emoji foi renderizado perfeitamente. Na instrução seguinte o nome obtido do arquivo é retornado pelo método.
        </p>
        <p>
          Mas se o arquivo não existe o corpo da instrução if é executado e então é verificado se existe pelo menos um arquivo com a imagem do emoji raiz. Se existir o nome desse arquivo é retornado mas com um caractere ! precedendo o nome. Isto vai sinalizar para o chamador desse método que este arquivo não é exatamente o correto, mas apenas uma figura que se aproxima do emoji que deveria ser renderizado.
        </p>
        <p>
          Também uma entrada no HashMap é inserida com a informação de que o emoji foi renderizado com a figura do seu emoji raiz.
        </p>
        <p>
          No entanto se não existir nem a figura do emoji em um arquivo do disco, e nem mesmo do emoji raiz, o corpo do if na linha 141 é executado e o método retorna null.
        </p>
        <p>

        </p>
      </div>  

      <div class="comment">
        <p>getNewTag()</p>
        <p>
          O método recebe uma tag que insere emoji no arquivo original e retorna uma nova tag que deve substitui-la no arquivo cópia.
        </p>
        <p>
          Na linha 173 um objeto Matcher é criado para localizar o atributo alt na tag.
        </p>
        <p>
          A String com o valor do atributo alt é atribuído ao objeto utf8Emoji na linha 179. E o nome do arquivo que contém a figura deste emoji é obtido na linha 184.
        </p>
        <p>
          A nova tag que este método vai retornar dependerá do nome atribuído a utf8Emoji. Se for null não existe arquivo PNG para este emoji no disco do usuário e uma tag span é retornada. Se o nome do arquivo estiver precedido por um sinal de exclamação, trata-se do arquivo com a imagem do emoji raiz e será retornada uma tag que coloca uma moldura vermelha na renderização do emoji. Nos outros casos é retornada uma tag img que insere o arquivo correto para este emoji.
        </p>
      </div>

      <h4>Classe DownloadPngs</h4>

      <p>
        Classe encarregada de baixar os arquivos de imagens de emojis no site da Emojipedia.
      </p>

      <h4>Classe NormalizeFilenames</h4>

      <p>
        Faz o trabalho de normalizar os nomes dos arquivos baixados pela aplicação GetPngs.jar
      </p>

      <h2>Pacote util</h2>

      <h4>Classe Normalizer</h4>

      <p>
        Como um exemplo, tomemos o emoji 🇧🇷 que é codificado pelos seguintes UNICODES: U+1F1E7 U+1F1F7. Para renderizar este emoji uma página do WhatsApp Web o faria por intermédio de uma tag como esta abaixo:
      </p>

      <code class="htmlcode">
        &lt;img src="d5fceb6532643d0d84ffe09c40c481ecdf59e15a.gif" alt="🇧🇷" draggable="false" style="background-position: -60px -40px;" class="b92 emoji wa _3Whw5"&gt;
      </code>

      <p>
        Mas como este código não funciona offline, a ideia é gerar um novo arquivo - cópia do original - onde esta tag seria trocada por:
      </p>
      <code class="htmlcode">
        &lt;img src="1f1e7-1f1f7.png" alt="🇧🇷" width="20px" height="20px"&gt;
      </code>
      <p>
        Assim esta última tag renderizará o emoji desde que o arquivo <span class="filename">1f1e7-1f1f7.png</span> exista e contenha a figura do emoji da bandeira do Brasil.
      </p>
      <p>
        O programa teria que fazer esse tipo de conversão para qualquer tag como esta exemplificada acima.
      </p>
      <p>
        Portanto é necessário que o programa seja capaz de converter 🇧🇷 na string 1f1e7-1f1f7. Converter qualquer emoji codificado em UTF-8 em seus respectivos codepoints escritos em hexadecimal e separados por um tracinho (-).
      </p>
      <p>
        Mas também é preciso que possa converter o nome do arquivo <span class="filename">flag-brazil_1f1e7-1f1f7.png</span> em <span class="filename">1f1e7-1f1f7.png</span>. E fazer o mesmo com qualquer nome de arquivo PNG baixado da Emojipedia: extrair os codepoints que aparecem como sufixos nestes nomes de arquivos e normalizar para o mesmo padrão usado na conversão de emojis UTF-8 para sequências de codepoints em hexa.
      </p>
      <p>
        Ou seja, o algoritmo que vai converter UTF-8 emojis em strings de codepoints deve produzir <b>exatamente</b> o mesmo resultado que o algoritmo que vai normalizar os nomes dos arquivos obtidos na Emojipedia.
      </p>
      <p>
        Para tanto é necessário observar em detalhe que padrão é utilizado para codificar emojis em UTF-8. E também observar cuidadosamente o padrão utilizado pela Emojipedia para nomear os arquivos com figuras de emojis.
      </p>
      <p>
        No caso dos emojis codificados como caracteres há duas particularidades que precisam ser levadas em consideração:
      </p>
      <ol>
        <li>
          Podem fazer parte da string os chamados LOW SURROGATE BYTES, que servem apenas para decodificar os caracteres mas não fazem parte dos caracteres de definição do emoji
        </li>
        <li>
           O caractere UNICODE U+FE0F pode ou não fazer parte da definição do emoji aparecendo como o último caractere da string. Mas esse caractere pode ser omitido e mesmo assim o emoji é corretamente interpretado por um editor de textos.
        </li>
      </ol>
      <p>
        A consequência do item 1 para os nossos propósitos neste projeto é que LOW SURROGATE BYTES nunca constam nas strings de codepoints que são os sufixos dos nomes dos arquivos que serão baixados da Emojipedia.
      </p>
      <p>
        Portanto o algoritmo de conversão de string UTF-8 para string codepoint deve simplesmente desprezar qualquer LOW SURROGATE BYTE.
      </p>
      <p>
        Já a consequência do item 2 é que para um determinado emoji, o caractere U+FE0F pode estar presente na string UTF-8 mas não no nome do arquivo. Ou pode estar presente no nome do arquivo mas não na string UTF-8. Ou pode estar ausente em ambos ou presente em ambos. E isto é imprevisível.
      </p>
      <p>
        Portanto os algoritmos de normalização do programa irão eliminar códigos U+FE0F sempre que ocorrerem. Seja em strings UTF-8, seja como parte de nomes de arquivos.
      </p>
      <p>
        Também há uma particularidade em como o Emojipedia nomeia estes arquivos... A parte do sufixo com os codepoints inicia sempre com um underscore e os diferentes codepoints são separados entre si por um tracinho. No entanto, por algum motivo, às vezes um codepoint está repetido nesta string. Mas quando esta repetição ocorre ele é separado do anterior não por um tracinho, mas por um underscore.
      </p>
      <p>
        Este padrão também deve ser detectado pelo algoritmo para poder eliminar estes codepoints supérfluos.
      </p>
      <p>
        E esta é fundamentalmente a ideia do processo de normalização aplicada nos dois métodos da classe Normalizer do pacote util. 
      </p>

      <div class="javacode" style="width:650px;">

        <div class="linenumber">
        00</br>01</br>02</br>03</br>04</br>05</br>06</br>07</br>08</br>09</br>10</br>11</br>12</br>13</br>14</br>15</br>16</br>17</br>18</br>19</br>20</br>21</br>22</br>23</br>24</br>25</br>26</br>27</br>28</br>29</br>30</br>31</br>32</br>33</br>34</br>35</br>36</br>37</br>38</br>39</br>
        </div>
        <pre><code>
        <span class="xw52fz_reserved">public</span> <span class="xw52fz_reserved">static</span> <span class="xw52fz_classname">String</span> <span class="xw52fz_function">utf8ToCodepoints</span>(<span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">String</span> utf8Emoji)
        {
            <span class="xw52fz_classname">StringBuilder</span> codePoints = <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">StringBuilder</span>(64);
        
            <span class="xw52fz_comment">/*
            Le caractere por caractere UTF-8 e os converte para codepoint
            */</span>        
            <span class="xw52fz_reserved">for</span> (<span class="xw52fz_reserved">int</span> position = 0; position &lt; utf8Emoji.<span class="xw52fz_function">length</span>(); position++)
            {
                <span class="xw52fz_reserved">char</span> c = utf8Emoji.<span class="xw52fz_function">charAt</span>(position);
        
                <span class="xw52fz_comment">/*
                VARIATION SELECTOR-16 e LOW SURROGATES caracteres nao sao inclusos
                na representacao normalizada do emoji
                */</span>
                <span class="xw52fz_reserved">if</span> ((c == '\ufe0f') || (<span class="xw52fz_classname">Character</span>.<span class="xw52fz_function">isLowSurrogate</span>(c))) <span class="xw52fz_reserved">continue</span>;
        
                <span class="xw52fz_comment">/*
                Obtem o codepoint do UTF-8, converte para hexadecimal e insere na
                string que serah retornada pelo metodo
                */</span>            
                codePoints.<span class="xw52fz_function">append</span>
                (
                    <span class="xw52fz_classname">String</span>.<span class="xw52fz_function">format</span>
                    (
                        position == 0 ? <span class="xw52fz_literalstring">"%x"</span> : <span class="xw52fz_literalstring">"-%x"</span>, 
                        <span class="xw52fz_classname">Character</span>.<span class="xw52fz_function">codePointAt</span>(utf8Emoji, position)
                    )
                );
        
            }<span class="xw52fz_comment">//for
        </span>
        
            <span class="xw52fz_reserved">return</span> codePoints.<span class="xw52fz_function">toString</span>();
        
        }<span class="xw52fz_comment">//utf8ToCodepoints()
        </span>
        </code></pre>
      </div>

      <div class="comment">
        <p>utf8ToCodepoints()</p>
        <p>
          O método que converte strings UTF-8 para strings de codepoints.
        </p>
        <p>
          Na linha 03 o objeto <span class="xw52fz_classname">StringBuilder</span> codePoints é criado para armazenar a string de codepoints. E o loop da linha 08 lê a string UTF-8 caractere por caractere e a cada iteração os atribui à variável c na linha 10.
        </p>
        <p>
          A linha 16 testa se c é um LOW SURROGATE BYTE ou um UNICODE U+FE0F. Se sim, como estes caracteres devem ser desprezados, o loop pula direto para a próxima iteração.
        </p>
        <p>
          Mas se c não é LOW SURROGATE ou U+FE0F, seu código UNICODE é obtido,  convertido para uma string com este valor em hexadecimal, e essa string é então concatenada ao objeto codePoints.
        </p>
        <p>
          Ao fim do loop o conteúdo de codePoints é convertido em String pela chamada de <span class="xw52fz_function">toString()</span> e esse valor retornado para o chamador do método.
        </p>
      </div>

      

      <div class="javacode" style="width:650px;">

        <div class="linenumber">
        00</br>01</br>02</br>03</br>04</br>05</br>06</br>07</br>08</br>09</br>10</br>11</br>12</br>13</br>14</br>15</br>16</br>17</br>18</br>19</br>20</br>21</br>22</br>23</br>24</br>25</br>26</br>27</br>28</br>29</br>30</br>
        </div>
        <pre><code>
            <span class="xw52fz_reserved">public</span> <span class="xw52fz_reserved">static</span> <span class="xw52fz_classname">String</span> <span class="xw52fz_function">filenameToCodepoints</span>(<span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">String</span> filename)
            {
                            
                <span class="xw52fz_comment">/*
                Extrai do nome do arquivo a parte que eh o nome do emoji
                */</span>
                <span class="xw52fz_classname">String</span> emojiName = filename.<span class="xw52fz_function">replaceFirst</span>(<span class="xw52fz_literalstring">"_[0-9a-f_\\-]+\\.png"</span>, <span class="xw52fz_literalstring">""</span>);
        
                <span class="xw52fz_comment">/*
                Deleta do nome do arquivo:
                
                - A parte que eh nome do emoji
                - Qualquer codepoint repetido precedido por _
                - Qualquer codepoint VARIATION SELECTOR
                - A extensao .png
                
                Sobra apenas a string de codepoints que define o emoji
                */</span>
                <span class="xw52fz_reserved">return</span>
                (
                    filename.<span class="xw52fz_function">replaceFirst</span>(emojiName + <span class="xw52fz_literalstring">"_"</span>, <span class="xw52fz_literalstring">""</span>).
                    <span class="xw52fz_function">replaceAll</span>(<span class="xw52fz_literalstring">"_[0-9a-f]+"</span>,<span class="xw52fz_literalstring">""</span>).
                    <span class="xw52fz_function">replaceAll</span>(<span class="xw52fz_literalstring">"-fe0f"</span>,<span class="xw52fz_literalstring">""</span>).
                    <span class="xw52fz_function">replace</span>(<span class="xw52fz_literalstring">".png"</span>, <span class="xw52fz_literalstring">""</span>)
                );
                
            }<span class="xw52fz_comment">//filenameToCodepoints()
        </span>
        </code></pre>
      </div>

      <div class="comment">
        <p>
          filenameToCodepoints()
        </p>
        <p>
          Converte o nome de um arquivo PNG para string de codepoints.
        </p>
        <p>
          Na linha 07, a expressão regular é usada para deletar o sufixo com os codepoints do nome do arquivo. Então o que sobra e é atribuído ao objeto emojiName é apenas a string com o nome oficial do emoji por extenso.
        </p>
        <p>
          Mas se a intenção é exatamente obter estes codepoints, então por que uma expressão regular para deletar essa parte do nome do arquivo?
        </p>
        <p>
          Não deveria ser o contrário? Uma expressão regular para deletar <b>TUDO QUE NÂO FOSSE CODEPOINT</b> no nome do arquivo?
        </p>
        <p>Sim, mas é muito difícil criar uma regex para deletar apenas o nome do emoji. Porque este nome pode ter qualquer caractere, incluindo os mesmos caracteres que ocorrem no sufixo com os códigos em hexadecimal. Esta regex iria acabar incluindo na localização também parte do sufixo ou todo o sufixo.
        </p>
        <p>
          Portanto o truque aqui é deletar inicialmente o sufixo e atribuir o nome do emoji à variável emojiName.
        </p>
        <p>
          Em seguida emojiName é deletado do nome do arquivo e o que sobra é justamente o sufixo que queremos!
        </p>
        <p>
          Deste sufixo ainda será deletado, se houver, qualquer codepoint repetido (duplicado), qualquer codepoint VARIATION SELECTOR e também a extensão .png do arquivo. Retornando apenas a string de codepoints que define o emoji cuja figura se obtém ao abrir este mesmo arquivo.
        </p>
      </div>

      <h4>Classe DownloadPngs</h4>
      <p>
        Esta classe usa um arquivo com o código fonte da URL https://emojipedia.org/whatsapp/ para localizar e baixar os arquivos PNG com figuras de emojis estilo WhatsApp.
      </p>

      <h2>Pacote apps</h2>
      <h4>Classe Fix</h4>
      <p>
        Gera cópias de páginas salvas onde os emojis são renderizados.
      </p>
      <h4>Classe Normalize</h4>
      <p>
        Classe que normaliza os nomes dos arquivos PNG baixados da Emojipedia.
      </p>
      <h4>Classe GetPngs</h4>
      <p>
        O executável que obtém os arquivos PNGs no servidor da Emojipedia.
      </p>
       

    </section>

    <footer>

        <br/><hr/>

        <a href="introducao.html" target="frame" class="nav-button nav-button-prev">Anterior</a>

        <a href="frame.html" target="frame" class="nav-button nav-button-next">Próxima</a>

    </footer>
    
    
</body>
</html>