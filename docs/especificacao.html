<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/frames.css"/>
    <title>Especifica√ß√£o</title>
</head>
<body>
    <section class="frame-sections">
      <h1>Especifica√ß√£o</h1>

      <p>
        As classes do projeto ser√£o distribu√≠das em 5 pacotes:
      </p>
      <dl class="deflist-default">
        <dt>whatsappwebfix</dt>
        <dd>
          Cont√©m as classes WhatsAppEditor, NormalizeFilenames e DownloadPngs que fazem o trabalho principal em seus respectivos execut√°veis.
        <dt>whatsappwebfix.util</dt>
        <dd>
          Classes utilit√°rias com fun√ß√£o de prepara√ß√£o
        </dd> 
        <dt>whatsappwebfix.apps</dt>
        <dd>
          Classes execut√°veis do projeto
        </dd>
        <dt>whatsappwebfix.global</dt>
        <dd>
          Classes para constantes e defini√ß√µes gerais que possam ser acessadas por qualquer outra classe do projeto
        </dd> 
        <dt>whatsappwebfix.gui</dt>
        <dd>
          Classes para as interfaces gr√°ficas dos programas
        </dd>
      </dl>

      <h2>Pacote whatsappwebfix</h2>

      <h4>Classe WhatsAppEditor</h4>

      <p>
        Esta classe deve ser a encarregada de ler o arquivo de uma p√°gina WhatsApp salva e produzir uma c√≥pia desse arquivo onde os emojis inseridos pelo usu√°rio apare√ßam renderizados.
      </p>

      <iframe class="code" src="javacode/WhatsAppEditor.html"></iframe>

      
        <p>getNewTag()</p>
        <p>
          O m√©todo recebe uma tag que insere emoji no arquivo original e retorna uma nova tag que deve substitui-la no arquivo c√≥pia.
        </p>
        <p>
          Na linha 173 um objeto Matcher √© criado para localizar o atributo alt na tag.
        </p>
        <p>
          A String com o valor do atributo alt √© atribu√≠do ao objeto utf8Emoji na linha 179. E o nome do arquivo que cont√©m a figura deste emoji √© obtido na linha 184.
        </p>
        <p>
          A nova tag que este m√©todo vai retornar depender√° do nome atribu√≠do a utf8Emoji. Se for null n√£o existe arquivo PNG para este emoji no disco do usu√°rio e uma tag span √© retornada. Se o nome do arquivo estiver precedido por um sinal de exclama√ß√£o, trata-se do arquivo com a imagem do emoji raiz e ser√° retornada uma tag que coloca uma moldura vermelha na renderiza√ß√£o do emoji. Nos outros casos √© retornada uma tag img que insere o arquivo correto para este emoji.
        </p>
      

     
        <p>getNewTag()</p>
        <p>
          O m√©todo recebe uma tag que insere emoji no arquivo original e retorna uma nova tag que deve substitui-la no arquivo c√≥pia.
        </p>
        <p>
          Na linha 173 um objeto Matcher √© criado para localizar o atributo alt na tag.
        </p>
        <p>
          A String com o valor do atributo alt √© atribu√≠do ao objeto utf8Emoji na linha 179. E o nome do arquivo que cont√©m a figura deste emoji √© obtido na linha 184.
        </p>
        <p>
          A nova tag que este m√©todo vai retornar depender√° do nome atribu√≠do a utf8Emoji. Se for null n√£o existe arquivo PNG para este emoji no disco do usu√°rio e uma tag span √© retornada. Se o nome do arquivo estiver precedido por um sinal de exclama√ß√£o, trata-se do arquivo com a imagem do emoji raiz e ser√° retornada uma tag que coloca uma moldura vermelha na renderiza√ß√£o do emoji. Nos outros casos √© retornada uma tag img que insere o arquivo correto para este emoji.
        </p>
     

      <h4>Classe DownloadPngs</h4>

      <p>
        Classe encarregada de baixar os arquivos de imagens de emojis no site da Emojipedia.
      </p>

      <h4>Classe NormalizeFilenames</h4>

      <p>
        Faz o trabalho de normalizar os nomes dos arquivos baixados pela aplica√ß√£o GetPngs.jar
      </p>

      <h2>Pacote util</h2>

      <h4>Classe Normalizer</h4>

      <p>
        Como um exemplo, tomemos o emoji üáßüá∑ que √© codificado pelos seguintes UNICODES: U+1F1E7 U+1F1F7. Para renderizar este emoji uma p√°gina do WhatsApp Web o faria por interm√©dio de uma tag como esta abaixo:
      </p>

      <code class="htmlcode">
        &lt;img src="d5fceb6532643d0d84ffe09c40c481ecdf59e15a.gif" alt="üáßüá∑" draggable="false" style="background-position: -60px -40px;" class="b92 emoji wa _3Whw5"&gt;
      </code>

      <p>
        Mas como este c√≥digo n√£o funciona offline, a ideia √© gerar um novo arquivo - c√≥pia do original - onde esta tag seria trocada por:
      </p>
      <code class="htmlcode">
        &lt;img src="1f1e7-1f1f7.png" alt="üáßüá∑" width="20px" height="20px"&gt;
      </code>
      <p>
        Assim esta √∫ltima tag renderizar√° o emoji desde que o arquivo <span class="filename">1f1e7-1f1f7.png</span> exista e contenha a figura do emoji da bandeira do Brasil.
      </p>
      <p>
        O programa teria que fazer esse tipo de convers√£o para qualquer tag como esta exemplificada acima.
      </p>
      <p>
        Portanto √© necess√°rio que o programa seja capaz de converter üáßüá∑ na string 1f1e7-1f1f7. Converter qualquer emoji codificado em UTF-8 em seus respectivos codepoints escritos em hexadecimal e separados por um tracinho (-).
      </p>
      <p>
        Mas tamb√©m √© preciso que possa converter o nome do arquivo <span class="filename">flag-brazil_1f1e7-1f1f7.png</span> em <span class="filename">1f1e7-1f1f7.png</span>. E fazer o mesmo com qualquer nome de arquivo PNG baixado da Emojipedia: extrair os codepoints que aparecem como sufixos nestes nomes de arquivos e normalizar para o mesmo padr√£o usado na convers√£o de emojis UTF-8 para sequ√™ncias de codepoints em hexa.
      </p>
      <p>
        Ou seja, o algoritmo que vai converter UTF-8 emojis em strings de codepoints deve produzir <b>exatamente</b> o mesmo resultado que o algoritmo que vai normalizar os nomes dos arquivos obtidos na Emojipedia.
      </p>
      <p>
        Para tanto √© necess√°rio observar em detalhe que padr√£o √© utilizado para codificar emojis em UTF-8. E tamb√©m observar cuidadosamente o padr√£o utilizado pela Emojipedia para nomear os arquivos com figuras de emojis.
      </p>
      <p>
        No caso dos emojis codificados como caracteres h√° duas particularidades que precisam ser levadas em considera√ß√£o:
      </p>
      <ol>
        <li>
          Podem fazer parte da string os chamados LOW SURROGATE BYTES, que servem apenas para decodificar os caracteres mas n√£o fazem parte dos caracteres de defini√ß√£o do emoji
        </li>
        <li>
           O caractere UNICODE U+FE0F pode ou n√£o fazer parte da defini√ß√£o do emoji aparecendo como o √∫ltimo caractere da string. Mas esse caractere pode ser omitido e mesmo assim o emoji √© corretamente interpretado por um editor de textos.
        </li>
      </ol>
      <p>
        A consequ√™ncia do item 1 para os nossos prop√≥sitos neste projeto √© que LOW SURROGATE BYTES nunca constam nas strings de codepoints que s√£o os sufixos dos nomes dos arquivos que ser√£o baixados da Emojipedia.
      </p>
      <p>
        Portanto o algoritmo de convers√£o de string UTF-8 para string codepoint deve simplesmente desprezar qualquer LOW SURROGATE BYTE.
      </p>
      <p>
        J√° a consequ√™ncia do item 2 √© que para um determinado emoji, o caractere U+FE0F pode estar presente na string UTF-8 mas n√£o no nome do arquivo. Ou pode estar presente no nome do arquivo mas n√£o na string UTF-8. Ou pode estar ausente em ambos ou presente em ambos. E isto √© imprevis√≠vel.
      </p>
      <p>
        Portanto os algoritmos de normaliza√ß√£o do programa ir√£o eliminar c√≥digos U+FE0F sempre que ocorrerem. Seja em strings UTF-8, seja como parte de nomes de arquivos.
      </p>
      <p>
        Tamb√©m h√° uma particularidade em como o Emojipedia nomeia estes arquivos... A parte do sufixo com os codepoints inicia sempre com um underscore e os diferentes codepoints s√£o separados entre si por um tracinho. No entanto, por algum motivo, √†s vezes um codepoint est√° repetido nesta string. Mas quando esta repeti√ß√£o ocorre ele √© separado do anterior n√£o por um tracinho, mas por um underscore.
      </p>
      <p>
        Este padr√£o tamb√©m deve ser detectado pelo algoritmo para poder eliminar estes codepoints sup√©rfluos.
      </p>
      <p>
        E esta √© fundamentalmente a ideia do processo de normaliza√ß√£o aplicada nos dois m√©todos da classe Normalizer do pacote util. 
      </p>

      <div class="javacode" style="width:650px;">

        <div class="linenumber">
        00</br>01</br>02</br>03</br>04</br>05</br>06</br>07</br>08</br>09</br>10</br>11</br>12</br>13</br>14</br>15</br>16</br>17</br>18</br>19</br>20</br>21</br>22</br>23</br>24</br>25</br>26</br>27</br>28</br>29</br>30</br>31</br>32</br>33</br>34</br>35</br>36</br>37</br>38</br>39</br>
        </div>
        <pre><code>
        <span class="xw52fz_reserved">public</span> <span class="xw52fz_reserved">static</span> <span class="xw52fz_classname">String</span> <span class="xw52fz_function">utf8ToCodepoints</span>(<span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">String</span> utf8Emoji)
        {
            <span class="xw52fz_classname">StringBuilder</span> codePoints = <span class="xw52fz_reserved">new</span> <span class="xw52fz_classname">StringBuilder</span>(64);
        
            <span class="xw52fz_comment">/*
            Le caractere por caractere UTF-8 e os converte para codepoint
            */</span>        
            <span class="xw52fz_reserved">for</span> (<span class="xw52fz_reserved">int</span> position = 0; position &lt; utf8Emoji.<span class="xw52fz_function">length</span>(); position++)
            {
                <span class="xw52fz_reserved">char</span> c = utf8Emoji.<span class="xw52fz_function">charAt</span>(position);
        
                <span class="xw52fz_comment">/*
                VARIATION SELECTOR-16 e LOW SURROGATES caracteres nao sao inclusos
                na representacao normalizada do emoji
                */</span>
                <span class="xw52fz_reserved">if</span> ((c == '\ufe0f') || (<span class="xw52fz_classname">Character</span>.<span class="xw52fz_function">isLowSurrogate</span>(c))) <span class="xw52fz_reserved">continue</span>;
        
                <span class="xw52fz_comment">/*
                Obtem o codepoint do UTF-8, converte para hexadecimal e insere na
                string que serah retornada pelo metodo
                */</span>            
                codePoints.<span class="xw52fz_function">append</span>
                (
                    <span class="xw52fz_classname">String</span>.<span class="xw52fz_function">format</span>
                    (
                        position == 0 ? <span class="xw52fz_literalstring">"%x"</span> : <span class="xw52fz_literalstring">"-%x"</span>, 
                        <span class="xw52fz_classname">Character</span>.<span class="xw52fz_function">codePointAt</span>(utf8Emoji, position)
                    )
                );
        
            }<span class="xw52fz_comment">//for
        </span>
        
            <span class="xw52fz_reserved">return</span> codePoints.<span class="xw52fz_function">toString</span>();
        
        }<span class="xw52fz_comment">//utf8ToCodepoints()
        </span>
        </code></pre>
      </div>

      <div class="comment">
        <p>utf8ToCodepoints()</p>
        <p>
          O m√©todo que converte strings UTF-8 para strings de codepoints.
        </p>
        <p>
          Na linha 03 o objeto <span class="xw52fz_classname">StringBuilder</span> codePoints √© criado para armazenar a string de codepoints. E o loop da linha 08 l√™ a string UTF-8 caractere por caractere e a cada itera√ß√£o os atribui √† vari√°vel c na linha 10.
        </p>
        <p>
          A linha 16 testa se c √© um LOW SURROGATE BYTE ou um UNICODE U+FE0F. Se sim, como estes caracteres devem ser desprezados, o loop pula direto para a pr√≥xima itera√ß√£o.
        </p>
        <p>
          Mas se c n√£o √© LOW SURROGATE ou U+FE0F, seu c√≥digo UNICODE √© obtido,  convertido para uma string com este valor em hexadecimal, e essa string √© ent√£o concatenada ao objeto codePoints.
        </p>
        <p>
          Ao fim do loop o conte√∫do de codePoints √© convertido em String pela chamada de <span class="xw52fz_function">toString()</span> e esse valor retornado para o chamador do m√©todo.
        </p>
      </div>

      

      <div class="javacode" style="width:650px;">

        <div class="linenumber">
        00</br>01</br>02</br>03</br>04</br>05</br>06</br>07</br>08</br>09</br>10</br>11</br>12</br>13</br>14</br>15</br>16</br>17</br>18</br>19</br>20</br>21</br>22</br>23</br>24</br>25</br>26</br>27</br>28</br>29</br>30</br>
        </div>
        <pre><code>
            <span class="xw52fz_reserved">public</span> <span class="xw52fz_reserved">static</span> <span class="xw52fz_classname">String</span> <span class="xw52fz_function">filenameToCodepoints</span>(<span class="xw52fz_reserved">final</span> <span class="xw52fz_classname">String</span> filename)
            {
                            
                <span class="xw52fz_comment">/*
                Extrai do nome do arquivo a parte que eh o nome do emoji
                */</span>
                <span class="xw52fz_classname">String</span> emojiName = filename.<span class="xw52fz_function">replaceFirst</span>(<span class="xw52fz_literalstring">"_[0-9a-f_\\-]+\\.png"</span>, <span class="xw52fz_literalstring">""</span>);
        
                <span class="xw52fz_comment">/*
                Deleta do nome do arquivo:
                
                - A parte que eh nome do emoji
                - Qualquer codepoint repetido precedido por _
                - Qualquer codepoint VARIATION SELECTOR
                - A extensao .png
                
                Sobra apenas a string de codepoints que define o emoji
                */</span>
                <span class="xw52fz_reserved">return</span>
                (
                    filename.<span class="xw52fz_function">replaceFirst</span>(emojiName + <span class="xw52fz_literalstring">"_"</span>, <span class="xw52fz_literalstring">""</span>).
                    <span class="xw52fz_function">replaceAll</span>(<span class="xw52fz_literalstring">"_[0-9a-f]+"</span>,<span class="xw52fz_literalstring">""</span>).
                    <span class="xw52fz_function">replaceAll</span>(<span class="xw52fz_literalstring">"-fe0f"</span>,<span class="xw52fz_literalstring">""</span>).
                    <span class="xw52fz_function">replace</span>(<span class="xw52fz_literalstring">".png"</span>, <span class="xw52fz_literalstring">""</span>)
                );
                
            }<span class="xw52fz_comment">//filenameToCodepoints()
        </span>
        </code></pre>
      </div>

      <div class="comment">
        <p>
          filenameToCodepoints()
        </p>
        <p>
          Converte o nome de um arquivo PNG para string de codepoints.
        </p>
        <p>
          Na linha 07, a express√£o regular √© usada para deletar o sufixo com os codepoints do nome do arquivo. Ent√£o o que sobra e √© atribu√≠do ao objeto emojiName √© apenas a string com o nome oficial do emoji por extenso.
        </p>
        <p>
          Mas se a inten√ß√£o √© exatamente obter estes codepoints, ent√£o por que uma express√£o regular para deletar essa parte do nome do arquivo?
        </p>
        <p>
          N√£o deveria ser o contr√°rio? Uma express√£o regular para deletar <b>TUDO QUE N√ÇO FOSSE CODEPOINT</b> no nome do arquivo?
        </p>
        <p>Sim, mas √© muito dif√≠cil criar uma regex para deletar apenas o nome do emoji. Porque este nome pode ter qualquer caractere, incluindo os mesmos caracteres que ocorrem no sufixo com os c√≥digos em hexadecimal. Esta regex iria acabar incluindo na localiza√ß√£o tamb√©m parte do sufixo ou todo o sufixo.
        </p>
        <p>
          Portanto o truque aqui √© deletar inicialmente o sufixo e atribuir o nome do emoji √† vari√°vel emojiName.
        </p>
        <p>
          Em seguida emojiName √© deletado do nome do arquivo e o que sobra √© justamente o sufixo que queremos!
        </p>
        <p>
          Deste sufixo ainda ser√° deletado, se houver, qualquer codepoint repetido (duplicado), qualquer codepoint VARIATION SELECTOR e tamb√©m a extens√£o .png do arquivo. Retornando apenas a string de codepoints que define o emoji cuja figura se obt√©m ao abrir este mesmo arquivo.
        </p>
      </div>

      <h4>Classe DownloadPngs</h4>
      <p>
        Esta classe usa um arquivo com o c√≥digo fonte da URL https://emojipedia.org/whatsapp/ para localizar e baixar os arquivos PNG com figuras de emojis estilo WhatsApp.
      </p>

      <h2>Pacote apps</h2>
      <h4>Classe Fix</h4>
      <p>
        Gera c√≥pias de p√°ginas salvas onde os emojis s√£o renderizados.
      </p>
      <h4>Classe Normalize</h4>
      <p>
        Classe que normaliza os nomes dos arquivos PNG baixados da Emojipedia.
      </p>
      <h4>Classe GetPngs</h4>
      <p>
        O execut√°vel que obt√©m os arquivos PNGs no servidor da Emojipedia.
      </p>
       

    </section>

    <footer>

        <br/><hr/>

        <a href="introducao.html" target="frame" class="nav-button nav-button-prev">Anterior</a>

        <a href="frame.html" target="frame" class="nav-button nav-button-next">Pr√≥xima</a>

    </footer>
    
    
</body>
</html>